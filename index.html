<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§ç©¿æ­æ°£è±¡ç«™ (å«åœ°éœ‡/é›ªè¨Š)</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ FontAwesome åœ–ç¤ºåº« -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%); /* æ·±è‰²èƒŒæ™¯ */
            min-height: 100vh;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ç»ç’ƒæ“¬æ…‹é¢æ¿ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* è¼‰å…¥å‹•ç•« */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #38bdf8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden-el { display: none; opacity: 0; }
        
        /* é€²å ´å‹•ç•« */
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* æ¨™ç±¤æ¨£å¼ */
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-right: 6px;
            margin-bottom: 6px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        .tag:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
        .tag i { margin-right: 6px; }

        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .scale-click:active { transform: scale(0.95); }

        /* é¡å¤–è³‡è¨Šå¡ç‰‡æ¨£å¼ */
        .info-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 0.75rem;
            padding: 12px;
            transition: all 0.3s;
        }
        .info-card:hover {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* é›ªè¨Šç‰¹åˆ¥æ¨£å¼ */
        .snow-card {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.15) 0%, rgba(59, 130, 246, 0.15) 100%);
            border: 1px solid rgba(165, 243, 252, 0.3);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.1);
        }
        .snow-card:hover {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.25) 0%, rgba(59, 130, 246, 0.25) 100%);
        }

        /* æœªä¾†é å ±ç‰¹åˆ¥æ¨£å¼ */
        .forecast-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* æµ®å‹•å‹•ç•« (çµ¦åœ–ç¤ºç”¨) */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        /* çµ¦æ¯å€‹åœ–ç¤ºä¸€é»å»¶é²ï¼Œè®“ç•«é¢ä¸è¦å¤ªæ•´é½Š */
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }

        /* æ•¸å­—å­—é«”å„ªåŒ– */
        .num-font {
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.02em;
        }
    </style>
</head>
<body>

    <div class="glass-panel w-full max-w-md rounded-[2rem] p-6 text-white relative overflow-hidden shadow-2xl my-4">
        
        <!-- Header & Date -->
        <div class="text-center mb-6 z-10 relative">
            <h1 class="text-xl font-bold flex items-center justify-center gap-2">
                <span id="locationName">åœ¨åœ°æ°£è±¡é¡§å•</span>
            </h1>
            <div id="dateDisplay" class="text-indigo-200 text-sm mt-1 font-medium tracking-wide">
                <!-- JS will inject date -->
            </div>
        </div>

        <!-- Input & Controls -->
        <div class="flex flex-col gap-3 mb-6 relative z-10">
            <!-- æ‰‹å‹•è¼¸å…¥æ¡† -->
            <input type="text" id="manualCityInput" placeholder="è«‹è¼¸å…¥åŸå¸‚åç¨± (ä¾‹å¦‚: Taipei, Tokyo)" 
                class="w-full bg-slate-900/60 border border-white/30 rounded-xl px-4 py-4 text-white placeholder-slate-400 focus:outline-none focus:border-blue-400 focus:bg-slate-900/80 transition-all backdrop-blur-md shadow-inner text-base tracking-wide"
                onkeypress="if(event.key === 'Enter') manualSearch()"
                style="text-shadow: 0 1px 2px rgba(0,0,0,0.5);" 
            >
            
            <!-- æœå°‹æŒ‰éˆ• -->
            <button onclick="manualSearch()" 
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 border border-white/10 scale-click">
                <i class="fa-solid fa-magnifying-glass"></i>
                <span>æœå°‹å¤©æ°£</span>
            </button>
            
            <!-- GPS å®šä½æŒ‰éˆ• (ä¸€éµå®šä½) -->
            <button onclick="startWeatherProcess()" 
                class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-400 hover:to-teal-500 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 border border-white/10 scale-click">
                <i class="fa-solid fa-location-crosshairs animate-pulse"></i>
                <span>ä¸€éµè‡ªå‹•å®šä½</span>
            </button>

            <!-- ç‹€æ…‹è¨Šæ¯ -->
            <p id="statusMsg" class="text-xs text-blue-200 min-h-[1.5rem] text-center"></p>
            <div id="btnLoader" class="loader hidden-el mx-auto"></div>
        </div>

        <!-- Weather Result Container -->
        <div id="weatherResult" class="hidden-el flex flex-col gap-5 relative z-10">
            
            <!-- 1. ä¸»æ°£è±¡å¡ç‰‡ -->
            <div class="flex items-center justify-between bg-white/5 rounded-2xl p-5 border border-white/10 relative overflow-hidden group">
                <div class="absolute inset-0 bg-blue-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <div class="relative z-10">
                    <!-- åŠ å…¥ num-font å„ªåŒ–æ•¸å­—é¡¯ç¤º -->
                    <div class="text-5xl font-bold tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-white to-blue-200 num-font" id="currentTemp">--Â°</div>
                    <div class="text-sm font-medium text-blue-300 mt-1 flex items-center gap-2">
                        <span id="weatherDesc">--</span>
                        <span class="text-xs text-slate-400">| é«”æ„Ÿ <span class="num-font" id="apparentTemp">--</span>Â°</span>
                    </div>
                </div>
                <div class="text-center relative z-10">
                    <i id="weatherIcon" class="fa-solid fa-cloud text-5xl text-blue-100 drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] animate-float"></i>
                </div>
            </div>

            <!-- 2. AI ç©¿æ­å»ºè­° -->
            <div class="bg-gradient-to-br from-indigo-500/20 to-purple-500/20 rounded-2xl p-5 border border-white/10">
                <h3 class="text-xs font-bold text-indigo-200 uppercase tracking-wider mb-3 flex items-center">
                    <i class="fa-solid fa-shirt mr-2"></i> å‡ºé–€ç©¿æ­å»ºè­°
                </h3>
                <div id="outfitTags" class="flex flex-wrap">
                    <!-- Tags injected via JS -->
                </div>
                <div id="outfitSummary" class="text-sm text-slate-200 mt-3 leading-relaxed font-light border-t border-white/10 pt-3">
                    <!-- Summary text -->
                </div>
            </div>

            <!-- 3. è©³ç´°æ•¸æ“š (é™é›¨ã€é¢¨é€Ÿã€ç©ºæ°£) -->
            <div class="grid grid-cols-3 gap-2">
                <!-- Rain -->
                <div class="bg-white/5 rounded-xl p-2 py-3 flex flex-col items-center justify-center border border-white/5">
                    <i class="fa-solid fa-umbrella text-blue-400 mb-1 text-sm"></i>
                    <div class="text-xs text-slate-400">é™é›¨ç‡</div>
                    <div class="font-bold text-sm num-font"><span id="rainProb">--</span>%</div>
                </div>
                <!-- Wind -->
                <div class="bg-white/5 rounded-xl p-2 py-3 flex flex-col items-center justify-center border border-white/5">
                    <i class="fa-solid fa-wind text-gray-400 mb-1 text-sm"></i>
                    <div class="text-xs text-slate-400">é¢¨é€Ÿ</div>
                    <div class="font-bold text-sm num-font"><span id="windSpeed">--</span> <span class="text-[10px]">km/h</span></div>
                </div>
                <!-- AQI -->
                <div class="bg-white/5 rounded-xl p-2 py-3 flex flex-col items-center justify-center border border-white/5">
                    <i class="fa-solid fa-lungs text-green-400 mb-1 text-sm"></i>
                    <div class="text-xs text-slate-400">ç©ºæ°£</div>
                    <div class="font-bold text-sm num-font" id="aqiText">--</div>
                </div>
            </div>
            
            <!-- 4 & 5. ä¸¦åˆ—é¡¯ç¤ºï¼šæœªä¾†8å°æ™‚é å ± & é›ªè¨Šé å ± -->
            <div class="grid grid-cols-2 gap-3 h-48">
                
                <!-- å·¦å´ï¼šæœªä¾† 8 å°æ™‚é å ± -->
                <div class="info-card forecast-card overflow-hidden flex flex-col h-full">
                    <h4 class="text-[10px] text-slate-400 mb-2 uppercase tracking-wide font-bold flex items-center gap-1">
                        <i class="fa-regular fa-clock"></i> æœªä¾† 8 å°æ™‚
                    </h4>
                    <div class="overflow-y-auto scrollbar-hide flex-1 pr-1">
                        <div class="flex flex-col gap-2" id="forecastContainer">
                            <!-- Forecast items injected via JS -->
                        </div>
                    </div>
                </div>

                <!-- å³å´ï¼šé›ªè¨Šé å ± -->
                <div id="snowSection" class="info-card snow-card hidden-el relative overflow-hidden flex flex-col h-full">
                    <!-- è£é£¾èƒŒæ™¯å…‰ -->
                    <div class="absolute -right-5 -top-5 w-20 h-20 bg-white/20 rounded-full blur-xl pointer-events-none"></div>
                    
                    <h4 class="text-[10px] font-bold text-cyan-200 mb-2 flex items-center gap-1 uppercase tracking-wide">
                        <i class="fa-regular fa-snowflake animate-pulse"></i> 3æ—¥é›ªè¨Š
                    </h4>
                    <div id="snowContent" class="text-xs font-medium pl-1 overflow-y-auto scrollbar-hide flex-1">
                        <!-- Snow items injected via JS -->
                    </div>
                </div>
            </div>

            <!-- 6. åœ°éœ‡è³‡è¨Š (ç¨ç«‹å€å¡Šï¼Œç§»è‡³æœ€ä¸‹æ–¹) -->
            <div id="quakeSection" class="info-card">
                <h4 class="text-xs text-slate-400 mb-2 flex items-center gap-1">
                    <i class="fa-solid fa-house-crack text-orange-400"></i> è¿‘ 3 å¤©å‘¨é‚Šåœ°éœ‡ (åŠå¾‘500km)
                </h4>
                <div id="quakeContent" class="space-y-2">
                    <div class="text-xs text-slate-500 py-1">è³‡æ–™è¼‰å…¥ä¸­...</div>
                </div>
            </div>

        </div>

        <div class="mt-4 text-center text-[10px] text-slate-600">
            Powered by Open-Meteo & USGS Earthquake Hazards Program
        </div>
    </div>

    <script>
        // --- ä»‹é¢å…ƒä»¶åƒè€ƒ ---
        const ui = {
            loader: document.getElementById('btnLoader'),
            msg: document.getElementById('statusMsg'),
            result: document.getElementById('weatherResult'),
            locName: document.getElementById('locationName'),
            temp: document.getElementById('currentTemp'),
            apparent: document.getElementById('apparentTemp'),
            desc: document.getElementById('weatherDesc'),
            icon: document.getElementById('weatherIcon'),
            rain: document.getElementById('rainProb'),
            wind: document.getElementById('windSpeed'),
            aqi: document.getElementById('aqiText'),
            tags: document.getElementById('outfitTags'),
            summary: document.getElementById('outfitSummary'),
            forecast: document.getElementById('forecastContainer'),
            dateDisplay: document.getElementById('dateDisplay'),
            manualInput: document.getElementById('manualCityInput'),
            snowSection: document.getElementById('snowSection'),
            snowContent: document.getElementById('snowContent'),
            quakeContent: document.getElementById('quakeContent')
        };

        // --- å¤©æ°£ä»£ç¢¼å°ç…§è¡¨ ---
        const weatherCodes = {
            0: {d:"æ™´æœ—", i:"fa-sun"}, 1: {d:"å¤šé›²æ™‚æ™´", i:"fa-cloud-sun"}, 2: {d:"å¤šé›²", i:"fa-cloud"}, 
            3: {d:"é™°å¤©", i:"fa-cloud"}, 45: {d:"éœ§", i:"fa-smog"}, 
            51: {d:"ç´°é›¨", i:"fa-cloud-rain"}, 61: {d:"å°é›¨", i:"fa-cloud-rain"}, 63: {d:"ä¸­é›¨", i:"fa-cloud-rain"}, 
            65: {d:"å¤§é›¨", i:"fa-cloud-showers-heavy"}, 71: {d:"å°é›ª", i:"fa-snowflake"}, 73: {d:"ä¸­é›ª", i:"fa-snowflake"}, 
            75: {d:"å¤§é›ª", i:"fa-snowflake"}, 80: {d:"é™£é›¨", i:"fa-cloud-sun-rain"}, 95: {d:"é›·é›¨", i:"fa-bolt"}
        };

        // --- 1. åŸºç¤åŠŸèƒ½ ---
        
        // åˆå§‹åŒ–æ—¥æœŸ
        (function initDate() {
            const now = new Date();
            ui.dateDisplay.textContent = now.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
        })();

        // è¨­å®šè¼‰å…¥ç‹€æ…‹
        function setWeatherState(loading, msg) {
            ui.loader.style.display = loading ? "inline-block" : "none";
            ui.msg.textContent = msg;
            if (loading) {
                ui.result.style.display = 'none';
                ui.result.classList.remove('fade-in');
            }
        }

        // æ’­æ”¾æç¤ºéŸ³æ•ˆ
        function playChime() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                
                const ctx = new AudioContext();
                const now = ctx.currentTime;
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0, now + i*0.1);
                    gain.gain.linearRampToValueAtTime(0.05, now + i*0.1 + 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 1.2);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(now + i*0.1);
                    osc.stop(now + i*0.1 + 1.5);
                });
            } catch(e) { console.error("Audio error", e); }
        }

        // --- 2. å®šä½èˆ‡æœå°‹é‚è¼¯ ---

        // æ‰‹å‹•æœå°‹
        async function manualSearch() {
            const city = ui.manualInput.value.trim();
            if(!city) {
                ui.msg.textContent = "è«‹è¼¸å…¥åŸå¸‚åç¨±";
                return;
            }
            
            setWeatherState(true, `æ­£åœ¨æœå°‹ ${city} ...`);
            
            try {
                // ä½¿ç”¨ Nominatim æœå°‹åŸå¸‚åº§æ¨™
                const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(city)}&format=json&limit=1`);
                const geoData = await geoRes.json();
                
                if(geoData && geoData.length > 0) {
                    const lat = geoData[0].lat;
                    const lon = geoData[0].lon;
                    const name = city; 
                    ui.locName.innerHTML = `<i class="fa-solid fa-location-dot text-blue-400"></i> ${name}`;
                    fetchWeatherData(lat, lon);
                } else {
                    setWeatherState(false, "æ‰¾ä¸åˆ°è©²åŸå¸‚ï¼Œè«‹å˜—è©¦è¼¸å…¥è‹±æ–‡åç¨± (ä¾‹å¦‚: Taipei)");
                }
            } catch(e) {
                setWeatherState(false, "æœå°‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
            }
        }

        // GPS å®šä½ (æ ¡æ­£ç‰ˆ)
        async function startWeatherProcess() {
            setWeatherState(true, "æ­£åœ¨å–å¾— GPS æ¬Šé™èˆ‡ä½ç½®...");
            
            if (!navigator.geolocation) {
                setWeatherState(false, "æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ GPS å®šä½åŠŸèƒ½");
                return;
            }

            const options = {
                enableHighAccuracy: false, // æ”¹ç‚º false ä»¥æé«˜æˆåŠŸç‡ (æ°£è±¡ä¸éœ€è¦æ¥µé«˜ç²¾æº–åº¦)
                timeout: 15000,           // å»¶é•·è¶…æ™‚æ™‚é–“è‡³ 15 ç§’
                maximumAge: 300000        // å…è¨±ä½¿ç”¨ 5 åˆ†é˜å…§çš„å¿«å–ä½ç½®
            };

            navigator.geolocation.getCurrentPosition(
                async pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    
                    setWeatherState(true, "å®šä½æˆåŠŸï¼æ­£åœ¨åˆ†ææ°£è±¡è³‡æ–™...");

                    // é€†å‘åœ°ç†ç·¨ç¢¼å–å¾—åœ°å
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&zoom=10`);
                        if (!geoRes.ok) throw new Error("Geo API error");
                        const geoData = await geoRes.json();
                        const city = geoData.address.city || geoData.address.town || geoData.address.county || geoData.address.village || "GPS ä½ç½®";
                        ui.locName.innerHTML = `<i class="fa-solid fa-location-dot text-blue-400"></i> ${city}`;
                        ui.manualInput.value = city;
                    } catch(e) {
                        console.warn("Reverse geocoding failed", e);
                        ui.locName.innerHTML = `<i class="fa-solid fa-location-dot text-blue-400"></i> æ‚¨çš„ä½ç½®`;
                    }
                    
                    fetchWeatherData(lat, lon);
                },
                err => {
                    console.warn(err);
                    let errorMsg = "å®šä½å¤±æ•—";
                    switch(err.code) {
                        case err.PERMISSION_DENIED:
                            errorMsg = "æ‚¨æ‹’çµ•äº†å®šä½æ¬Šé™ï¼Œè«‹è‡³ç€è¦½å™¨è¨­å®šé–‹å•Ÿ";
                            break;
                        case err.POSITION_UNAVAILABLE:
                            errorMsg = "ç„¡æ³•åµæ¸¬ç›®å‰ä½ç½® (è¨Šè™Ÿå¾®å¼±)";
                            break;
                        case err.TIMEOUT:
                            errorMsg = "å®šä½è«‹æ±‚é€¾æ™‚ï¼Œè«‹å†è©¦ä¸€æ¬¡";
                            break;
                        default:
                            errorMsg = "å®šä½ç™¼ç”Ÿæœªé æœŸéŒ¯èª¤";
                    }
                    setWeatherState(false, errorMsg);
                },
                options
            );
        }

        // --- 3. ç²å–å¤©æ°£è³‡æ–™ ---
        async function fetchWeatherData(lat, lon) {
            try {
                // è¨ˆç®—3å¤©å‰çš„æ—¥æœŸç”¨æ–¼åœ°éœ‡æŸ¥è©¢
                const threeDaysAgo = new Date();
                threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
                const quakeStartDate = threeDaysAgo.toISOString().split('T')[0];

                // ä¸¦è¡Œè«‹æ±‚ API
                // 1. å¤©æ°£ (å«é›ªè¨Š forecast_days=3)
                // 2. ç©ºæ°£å“è³ª
                // 3. åœ°éœ‡ (USGS)
                const [wRes, aRes, qRes] = await Promise.all([
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation_probability,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code&daily=snowfall_sum&forecast_days=3&timezone=auto`),
                    fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi`),
                    fetch(`https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&latitude=${lat}&longitude=${lon}&maxradiuskm=500&starttime=${quakeStartDate}&minmagnitude=3&orderby=time&limit=3`)
                ]);
                
                if (!wRes.ok || !aRes.ok) throw new Error("API Error");

                const wData = await wRes.json();
                const aData = await aRes.json();
                
                // åœ°éœ‡è³‡æ–™å¯èƒ½å› å€åŸŸæ²’åœ°éœ‡è€Œç‚ºç©ºï¼Œéœ€å®¹éŒ¯
                let qData = { features: [] };
                if (qRes.ok) {
                    qData = await qRes.json();
                }
                
                renderWeather(wData, aData, qData);
                playChime();
                setWeatherState(false, "åˆ†æå®Œæˆ");
            } catch(e) {
                console.error(e);
                setWeatherState(false, "è³‡æ–™ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦");
            }
        }

        // --- å·¥å…·å‡½å¼ï¼šæ•¸å­—è·‘åˆ†å‹•ç•« ---
        function animateNumber(element, start, end, duration = 1000) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                // ä½¿ç”¨ easeOutExpo æ•ˆæœ
                const easeProgress = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
                
                const currentVal = Math.floor(easeProgress * (end - start) + start);
                element.textContent = currentVal + "Â°";
                
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // --- å·¥å…·å‡½å¼ï¼šç¿»è­¯åœ°éœ‡ä½ç½® ---
        function translatePlace(place) {
            let t = place;
            t = t.replace(/Taiwan/g, "å°ç£");
            t = t.replace(/Japan/g, "æ—¥æœ¬");
            t = t.replace(/Philippines/g, "è²å¾‹è³“");
            t = t.replace(/China/g, "ä¸­åœ‹");
            t = t.replace(/South Korea/g, "å—éŸ“");
            t = t.replace(/Indonesia/g, "å°å°¼");
            t = t.replace(/km/g, "å…¬é‡Œ");
            t = t.replace(/ of /g, " ä½æ–¼ ");
            t = t.replace(/South/g, "å—éƒ¨");
            t = t.replace(/North/g, "åŒ—éƒ¨");
            t = t.replace(/East/g, "æ±éƒ¨");
            t = t.replace(/West/g, "è¥¿éƒ¨");
            t = t.replace(/region/g, "åœ°å€");
            return t;
        }

        // --- 4. æ¸²æŸ“ç•«é¢ ---
        function renderWeather(w, a, q) {
            const cur = w.current;
            const aqiVal = a.current.us_aqi;
            
            // åŸºç¤æ•¸å€¼ (ä½¿ç”¨å‹•ç•«)
            const tempVal = Math.round(cur.temperature_2m);
            const appVal = Math.round(cur.apparent_temperature);
            
            // å¦‚æœåŸæœ¬æ²’æœ‰å€¼ï¼Œå¾ 0 é–‹å§‹ï¼Œå¦å‰‡å¾èˆŠå€¼é–‹å§‹ï¼ˆé€™è£¡ç°¡åŒ–å¾ 0 é–‹å§‹ï¼‰
            animateNumber(ui.temp, 0, tempVal);
            animateNumber(ui.apparent, 0, appVal);

            ui.rain.textContent = cur.precipitation_probability ?? 0;
            ui.wind.textContent = cur.wind_speed_10m;
            
            // å¤©æ°£ä»£ç¢¼åœ–ç¤º
            const code = cur.weather_code;
            const info = weatherCodes[code] || {d:"æœªçŸ¥", i:"fa-question"};
            ui.desc.textContent = info.d;
            ui.icon.className = `fa-solid ${info.i} text-5xl text-blue-100 drop-shadow-lg animate-float`;

            // ç©ºæ°£å“è³ª (AQI)
            let aqiStatus = "è‰¯å¥½";
            if(aqiVal > 50) aqiStatus = "æ™®é€š";
            if(aqiVal > 100) aqiStatus = "ä¸ä½³";
            ui.aqi.textContent = `${aqiVal} (${aqiStatus})`;
            ui.aqi.className = `font-bold text-sm ${aqiVal > 100 ? 'text-red-400' : 'text-green-400'}`;

            // ç”Ÿæˆç©¿æ­å»ºè­° (æ›´æ–°ï¼šå‚³å…¥æ˜¯å¦ä¸‹é›ª)
            const dailySnow = w.daily.snowfall_sum;
            const hasSnowForecast = dailySnow && dailySnow.some(s => s > 0);
            const advice = generateOutfitAdvice(
                cur.temperature_2m,
                cur.apparent_temperature,
                cur.precipitation_probability,
                cur.wind_speed_10m,
                aqiVal,
                code,
                hasSnowForecast
            );

            ui.tags.innerHTML = advice.tags.map(t => 
                `<span class="tag ${t.important ? 'bg-blue-500/40 border-blue-400' : ''} ${t.color}">
                    <i class="fa-solid ${t.icon}"></i>${t.text}
                 </span>`
            ).join('');
            ui.summary.innerHTML = advice.summary; // Use innerHTML to allow line breaks

            // --- ä¸¦åˆ—é¡¯ç¤ºï¼šé›ªè¨Šé å ± (3å¤©) ---
            const dailyTime = w.daily.time;
            let snowDays = [];
            
            if (dailySnow) {
                dailySnow.forEach((amount, idx) => {
                    if (amount > 0) {
                        snowDays.push({date: dailyTime[idx], amount: amount});
                    }
                });
            }

            ui.snowSection.style.display = 'flex'; // Force display for grid
            if (snowDays.length > 0) {
                ui.snowContent.innerHTML = snowDays.map(d => {
                    const dateObj = new Date(d.date);
                    const dateStr = `${dateObj.getMonth()+1}/${dateObj.getDate()}`;
                    return `<div class="flex justify-between border-b border-white/20 py-2 last:border-0 items-center">
                                <span class="font-bold text-white">${dateStr}</span>
                                <span class="text-white bg-blue-500/40 px-2 py-0.5 rounded-md font-bold text-xs">${d.amount} cm</span>
                            </div>`;
                }).join('');
            } else {
                ui.snowContent.innerHTML = `<div class="h-full flex items-center justify-center text-center"><span class="text-cyan-100/70 text-[10px]">æœªä¾† 3 å¤©<br>ç„¡æ˜é¡¯é™é›ª</span></div>`;
            }

            // --- ä¸¦åˆ—é¡¯ç¤ºï¼šæœªä¾†é å ± (å‚ç›´åˆ—è¡¨æ¨¡å¼) ---
            ui.forecast.innerHTML = '';
            const nowHour = new Date().getHours();
            let startIdx = 0;
            w.hourly.time.forEach((t, i) => {
                if(new Date(t).getHours() === nowHour) startIdx = i;
            });
            
            // åªé¡¯ç¤ºæ¥ä¸‹ä¾† 8 å°æ™‚
            for(let i=startIdx+1; i<=startIdx+8; i++) {
                if(!w.hourly.time[i]) break;
                const t = new Date(w.hourly.time[i]);
                const hCode = w.hourly.weather_code[i];
                const hInfo = weatherCodes[hCode] || {i:"fa-question"};
                
                ui.forecast.innerHTML += `
                    <div class="flex items-center justify-between bg-white/5 rounded-lg p-2 border border-white/5 hover:bg-white/10 transition-colors">
                        <span class="text-[10px] text-slate-400 font-mono w-10">${t.getHours()}:00</span>
                        <i class="fa-solid ${hInfo.i} text-sm text-blue-100 w-6 text-center"></i>
                        <span class="text-sm font-medium text-white num-font w-8 text-right">${Math.round(w.hourly.temperature_2m[i])}Â°</span>
                    </div>
                `;
            }

            // --- åœ°éœ‡è³‡è¨Š (3å¤©å…§, åŠå¾‘500km) ---
            const quakes = q.features || [];
            if (quakes.length > 0) {
                ui.quakeContent.innerHTML = quakes.map(f => {
                    const props = f.properties;
                    const date = new Date(props.time);
                    const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
                    
                    // å–å¾—åº§æ¨™èˆ‡åœ°å
                    const coords = f.geometry.coordinates; // [lon, lat, depth]
                    const place = translatePlace(props.place);
                    
                    // Google Maps Link
                    const googleMapUrl = `https://www.google.com/maps/search/?api=1&query=${coords[1]},${coords[0]}`;
                    
                    const magColor = props.mag >= 5 ? "text-red-400" : (props.mag >= 4 ? "text-orange-400" : "text-yellow-300");
                    
                    return `
                        <div class="flex flex-col border-b border-white/5 pb-2 last:border-0 last:pb-0">
                            <div class="flex justify-between items-center mb-0.5">
                                <span class="font-bold ${magColor}">M ${props.mag.toFixed(1)}</span>
                                <span class="text-[10px] text-slate-400">${dateStr}</span>
                            </div>
                            <div class="text-xs text-slate-300 truncate" title="${place}">${place}</div>
                            
                            <a href="${googleMapUrl}" target="_blank" class="mt-1 flex items-center gap-1.5 text-[10px] text-indigo-300 hover:text-indigo-100 bg-indigo-500/10 hover:bg-indigo-500/30 px-2 py-1 rounded transition-all w-fit">
                                <i class="fa-solid fa-map-pin"></i>
                                <span>æŸ¥çœ‹éœ‡å¤®: ${coords[1].toFixed(2)}, ${coords[0].toFixed(2)}</span>
                            </a>
                        </div>
                    `;
                }).join('');
            } else {
                ui.quakeContent.innerHTML = `<div class="text-xs text-slate-500">å‘¨é‚Š 500km å…§è¿‘ 3 å¤©ç„¡è¦æ¨¡ 3 ä»¥ä¸Šåœ°éœ‡</div>`;
            }

            // é¡¯ç¤ºçµæœå€å¡Š
            ui.result.style.display = 'flex';
            void ui.result.offsetWidth; // Trigger reflow
            ui.result.classList.add('fade-in');
        }
        
        // --- 5. ç©¿æ­é‚è¼¯ (æ›´æ–°ç‰ˆ) ---
        function generateOutfitAdvice(temp, apparentTemp, rainProb, windSpeed, aqi, weatherCode, hasSnowForecast) {
            let tags = [];
            let summary = "";

            // 1. åŸºç¤æ°£æº«å»ºè­°
            if (apparentTemp >= 30) {
                tags.push({text: "çŸ­è¢–/ç„¡è¢–", icon: "fa-shirt", color: "text-orange-300"});
                tags.push({text: "é€æ°£æè³ª", icon: "fa-wind", color: "text-blue-200"});
                summary = "å¤©æ°£éå¸¸ç‚ç†±ï¼Œè«‹ç©¿è‘—è¼•è–„é€æ°£çš„è¡£ç‰©ï¼Œé¿å…ä¸­æš‘ã€‚";
            } else if (apparentTemp >= 25) {
                tags.push({text: "çŸ­è¢–", icon: "fa-shirt", color: "text-yellow-200"});
                tags.push({text: "è–„é˜²æ›¬", icon: "fa-sun", color: "text-orange-200"});
                summary = "å¤©æ°£æº«æš–èˆ’é©ï¼ŒçŸ­è¢–æ­é…ä¸€ä»¶è–„è¥¯è¡«æˆ–è–„å¤–å¥—å³å¯ã€‚";
            } else if (apparentTemp >= 20) {
                tags.push({text: "è–„é•·è¢–", icon: "fa-user-tag", color: "text-green-200"});
                tags.push({text: "è–„å¤–å¥—", icon: "fa-layer-group", color: "text-green-200"});
                summary = "é«”æ„Ÿèˆ’é©å¾®æ¶¼ï¼Œå»ºè­°ç©¿è‘—è–„é•·è¢–ï¼Œæˆ–çŸ­è¢–å¤–æ­ä¸€ä»¶è–„å¤¾å…‹ã€‚";
            } else if (apparentTemp >= 15) {
                tags.push({text: "å¤¾å…‹/å¸½T", icon: "fa-vest", color: "text-blue-200"});
                tags.push({text: "é•·è¤²", icon: "fa-socks", color: "text-blue-200"});
                summary = "ç¨æœ‰æ¶¼æ„ï¼Œå»ºè­°ç©¿è‘—å¤§å­¸Tã€å¸½Tæˆ–å¤¾å…‹ï¼Œé¿å…è‘—æ¶¼ã€‚";
            } else {
                tags.push({text: "åšå¤–å¥—/ç¾½çµ¨", icon: "fa-snowflake", color: "text-blue-100"});
                tags.push({text: "åœå·¾", icon: "fa-scarf", color: "text-purple-200"});
                summary = "å¤©æ°£å¯’å†·ï¼Œè«‹å‹™å¿…åšå¥½ä¿æš–ï¼Œå»ºè­°ç©¿è‘—ä¿æš–å¤–å¥—èˆ‡åœå·¾ã€‚";
            }

            // 2. ç‰¹æ®Šå¤©æ°£æ¨™ç±¤èˆ‡è©³ç´°å»ºè­°
            if (rainProb >= 40 || (weatherCode >= 50 && weatherCode <= 69) || (weatherCode >= 80 && weatherCode <= 99)) {
                tags.push({text: "å‹™å¿…å¸¶å‚˜", icon: "fa-umbrella", color: "text-blue-400", important: true});
                summary += "<br>â˜” é™é›¨æ©Ÿç‡é«˜ï¼Œå‡ºé–€è«‹è¨˜å¾—æ”œå¸¶é›¨å…·ï¼Œé‹å­å»ºè­°é¸æ“‡é˜²æ½‘æ°´æè³ªã€‚";
            }

            // 3. ä¸‹é›ªè©³ç´°å»ºè­°
            if (hasSnowForecast || (weatherCode >= 70 && weatherCode <= 79) || temp < 2) {
                tags.push({text: "é˜²æ»‘é‹", icon: "fa-shoe-prints", color: "text-cyan-300", important: true});
                tags.push({text: "é˜²æ°´å¤–å¥—", icon: "fa-droplet", color: "text-cyan-200"});
                tags.push({text: "æ¯›å¸½æ‰‹å¥—", icon: "fa-mitten", color: "text-pink-200"});
                
                summary += "<br>â„ï¸ <strong class='text-cyan-200'>ä¸‹é›ª/ä½æº«æ³¨æ„äº‹é …ï¼š</strong>";
                summary += "<ul class='list-disc list-inside mt-1 space-y-1 text-slate-300'>";
                summary += "<li><strong>æ´‹è”¥å¼ç©¿æ­ï¼š</strong>å…§å±¤æ’æ±—ã€ä¸­å±¤ä¿æš–ã€å¤–å±¤é˜²é¢¨é˜²æ°´ã€‚</li>";
                summary += "<li><strong>é˜²æ»‘ï¼š</strong>è·¯é¢å¯èƒ½çµå†°æº¼æ»‘ï¼Œè«‹ç©¿è‘—æ·±ç´‹è·¯çš„é˜²æ»‘é´ã€‚</li>";
                summary += "<li><strong>ä¿æš–æœ«æ¢¢ï¼š</strong>æˆ´ä¸Šæ¯›å¸½èˆ‡é˜²æ°´æ‰‹å¥—ï¼Œä¿è­·é ­éƒ¨èˆ‡é›™æ‰‹ã€‚</li>";
                summary += "<li><strong>é˜²æ°´ï¼š</strong>é›ªèåŒ–æœƒå¼„æ¿•è¡£ç‰©ï¼Œå¤–å±¤è¡£ç‰©å‹™å¿…é˜²æ°´ã€‚</li>";
                summary += "</ul>";
            }

            if (windSpeed >= 20) {
                tags.push({text: "é˜²é¢¨å¤–å¥—", icon: "fa-wind", color: "text-gray-300"});
                if(!summary.includes("ä¸‹é›ª")) {
                     summary += "<br>ğŸ’¨ é¢¨å‹¢è¼ƒå¤§ï¼Œå»ºè­°ç©¿è‘—é˜²é¢¨å¤–å¥—ä»¥é¿å…é«”æ„Ÿæº«åº¦éä½ã€‚";
                }
            }

            if (aqi > 100) {
                tags.push({text: "æˆ´å£ç½©", icon: "fa-mask-face", color: "text-red-400", important: true});
                summary += "<br>ğŸ˜· ç©ºæ°£å“è³ªä¸ä½³ï¼Œæ•æ„Ÿæ—ç¾¤è«‹é…æˆ´å£ç½©ã€‚";
            }

            if (weatherCode <= 1 && apparentTemp > 20) {
                tags.push({text: "å¢¨é¡/å¸½å­", icon: "fa-glasses", color: "text-yellow-400"});
            }

            return { tags, summary };
        }
    </script>
</body>
</html>
